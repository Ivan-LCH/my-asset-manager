# 📈 주식 데이터 자동 업데이트 설계 (Revised)

**작성일:** 2026-01-22  
**상태:** 설계 수정 (User Review 반영)

---

## 1. 개요 (Overview)
사용자가 보유한 주식 자산의 시장 가치를 자동으로 추적하기 위해 외부 API(`yfinance`)를 연동합니다.  
현재가 업데이트뿐만 아니라, **누락된 과거 이력(History) 데이터를 스마트하게 채워넣어(Backfill)** 자산 변동 추이를 연속성 있게 시각화합니다.

## 2. 핵심 로직 상세

### 2.1. 티커(Ticker) 기반 식별 및 중복 제거
- 자산 이름만으로는 정확한 시세 조회가 불가능하므로 `ticker` 컬럼을 사용합니다.
- **API 호출 최적화:** 여러 계좌에 동일 종목(`TSLA`)이 있어도, API 호출은 **Ticker 단위로 유니크하게 한 번만** 수행하여 결과를 공유합니다.

### 2.2. 스마트 데이터 수집 전략 (Backfill Logic)
API 호출 시 `start_date`를 동적으로 결정하여 필요한 데이터만 가져옵니다.

1. **대상 선정:** `stock_details`에 `ticker`가 있는 모든 자산.
2. **마지막 기록 확인:** 해당 자산의 `asset_history`에서 가장 최신 날짜(`max_date`)를 조회.
3. **조회 기간(Period) 결정:**
   - **CASE A (기록 없음):** `start_date` = `오늘 - 30일` (최소 1달치 확보)
   - **CASE B (기록 있음):** `start_date` = `max_date + 1일`
   - **예외 처리:** 만약 `start_date`가 오늘보다 미래라면(이미 최신), API 호출 패스하거나 현재가만 체크.

### 2.3. 데이터 적용 (Upsert)
- **현재가 갱신:** 가져온 데이터의 가장 최신 값(오늘 혹은 전일 종가)으로 `assets.current_value` 업데이트.
- **이력 저장:** 조회된 기간의 모든 일별 데이터를 `asset_history`에 저장. (기존 데이터와 겹치지 않게 처리)

---

## 3. UI 및 사용성 개선 (User Experience)

### 3.1. 티커 설정 도우미 (Ticker Helper)
- 사용자가 일일이 코드를 입력하는 것은 번거로움.
- **기능:** 자산 편집 화면에서 자산명("삼성전자")으로 **검색 버튼**을 누르면, 후보군("005930.KS", "005935.KS")을 보여주고 선택하게 함.

### 3.2. 수동/자동 실행
- **지금 업데이트:** 사이드바에 "🔄 주가 동기화" 버튼 배치. 클릭 시 전체 로직 1회 실행.
- **자동 스케줄러:** 매일 밤(또는 장 마감 후) 백그라운드 실행 (APScheduler).

---

## 4. 구현 단계 (Implementation Steps)

### Phase 1: 기반 마련 (DB & Utils)
1. `stock_details` 테이블에 `ticker` 컬럼 추가 (Migration).
2. `yfinance` 연동 유틸리티 함수 구현 (`get_stock_price(ticker, start_date)`).

### Phase 2: 티커 매핑 (UI)
1. `app.py` 주식 편집 화면에 `ticker` 입력란 및 검색 기능 추가.
2. 기존 자산들에 대해 티커 매핑 작업 지원.

### Phase 3: 업데이트 로직 구현
1. **일괄 업데이트 모듈:**
   - 전체 주식 자산 로드 -> Ticker별 그룹핑 -> API 호출(Backfill 로직 적용) -> DB 업데이트.
2. **자산 가치 재계산:** 주가 변동에 따라 `current_value` 자동 계산 (`수량 * 현재가 * 환율`).

### Phase 4: 자동화 및 검증
1. 업데이트 버튼 추가 및 테스트.
2. 스케줄러 연동.

---

## 5. 데이터 예시 흐름

**상황:** 
- 자산: "테슬라" (Ticker: `TSLA`)
- DB 마지막 기록: `2024-01-20`
- 오늘 날짜: `2024-01-22`

**로직 실행:**
1. `max_date` = `2024-01-20` 확인.
2. `start_date` = `2024-01-21` 설정.
3. `yfinance.download("TSLA", start="2024-01-21")` 호출.
4. 결과: `2024-01-21`(휴장일이면 없음), `2024-01-22`(현재가) 데이터 수신.
5. DB에 `2024-01-21`, `2024-01-22` 데이터 추가.
6. `assets.current_value`를 `2024-01-22` 가격 기준 `수량 * 가격 * 환율`로 업데이트.
